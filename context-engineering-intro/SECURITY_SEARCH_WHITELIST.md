# Security Search Field Whitelist

## Purpose
This whitelist defines which Contact model fields can be used in the advanced search API (`/contacts/search`). Fields NOT in this list should be rejected with HTTP 400.

## Implementation Location
- File: `backend/app/api/v1/contacts.py`
- Add after imports, before router definition
- Validate in `search_contacts` function

## ALLOWED_SEARCH_FIELDS

```python
# Security: Whitelist of fields allowed for contact search/filtering
# This prevents searching on sensitive internal fields like SHA256 hashes
ALLOWED_SEARCH_FIELDS = {
    # Basic Info
    "email",
    "phone",
    "normalized_phone",
    "first_name",
    "last_name",
    "company",

    # Status/Classification
    "status",
    "source",
    "assigned_to_id",
    "pipeline_id",
    "pipeline_stage",

    # Custom Data
    "custom_fields",
    "tags",
    "enrichment_data",
    "last_enriched_at",

    # Primary Address
    "street_address",
    "city",
    "state",
    "zip_code",
    "country",

    # Personal Address
    "personal_address",
    "personal_city",
    "personal_state",
    "personal_zip",
    "personal_zip4",

    # Demographics
    "age_range",
    "children",
    "gender",
    "homeowner",
    "married",
    "net_worth",
    "income_range",

    # Direct Numbers (1-30) + DNC flags
    "direct_number",
    "direct_number_dnc",
    "direct_number_2",
    "direct_number_2_dnc",
    "direct_number_3",
    "direct_number_3_dnc",
    "direct_number_4",
    "direct_number_4_dnc",
    "direct_number_5",
    "direct_number_5_dnc",
    "direct_number_6",
    "direct_number_6_dnc",
    "direct_number_7",
    "direct_number_7_dnc",
    "direct_number_8",
    "direct_number_8_dnc",
    "direct_number_9",
    "direct_number_9_dnc",
    "direct_number_10",
    "direct_number_10_dnc",
    "direct_number_11",
    "direct_number_11_dnc",
    "direct_number_12",
    "direct_number_12_dnc",
    "direct_number_13",
    "direct_number_13_dnc",
    "direct_number_14",
    "direct_number_14_dnc",
    "direct_number_15",
    "direct_number_15_dnc",
    "direct_number_16",
    "direct_number_16_dnc",
    "direct_number_17",
    "direct_number_17_dnc",
    "direct_number_18",
    "direct_number_18_dnc",
    "direct_number_19",
    "direct_number_19_dnc",
    "direct_number_20",
    "direct_number_20_dnc",
    "direct_number_21",
    "direct_number_21_dnc",
    "direct_number_22",
    "direct_number_22_dnc",
    "direct_number_23",
    "direct_number_23_dnc",
    "direct_number_24",
    "direct_number_24_dnc",
    "direct_number_25",
    "direct_number_25_dnc",
    "direct_number_26",
    "direct_number_26_dnc",
    "direct_number_27",
    "direct_number_27_dnc",
    "direct_number_28",
    "direct_number_28_dnc",
    "direct_number_29",
    "direct_number_29_dnc",
    "direct_number_30",
    "direct_number_30_dnc",

    # Mobile Phones (1-30) + DNC flags
    "mobile_phone",
    "mobile_phone_dnc",
    "mobile_phone_2",
    "mobile_phone_2_dnc",
    "mobile_phone_3",
    "mobile_phone_3_dnc",
    "mobile_phone_4",
    "mobile_phone_4_dnc",
    "mobile_phone_5",
    "mobile_phone_5_dnc",
    "mobile_phone_6",
    "mobile_phone_6_dnc",
    "mobile_phone_7",
    "mobile_phone_7_dnc",
    "mobile_phone_8",
    "mobile_phone_8_dnc",
    "mobile_phone_9",
    "mobile_phone_9_dnc",
    "mobile_phone_10",
    "mobile_phone_10_dnc",
    "mobile_phone_11",
    "mobile_phone_11_dnc",
    "mobile_phone_12",
    "mobile_phone_12_dnc",
    "mobile_phone_13",
    "mobile_phone_13_dnc",
    "mobile_phone_14",
    "mobile_phone_14_dnc",
    "mobile_phone_15",
    "mobile_phone_15_dnc",
    "mobile_phone_16",
    "mobile_phone_16_dnc",
    "mobile_phone_17",
    "mobile_phone_17_dnc",
    "mobile_phone_18",
    "mobile_phone_18_dnc",
    "mobile_phone_19",
    "mobile_phone_19_dnc",
    "mobile_phone_20",
    "mobile_phone_20_dnc",
    "mobile_phone_21",
    "mobile_phone_21_dnc",
    "mobile_phone_22",
    "mobile_phone_22_dnc",
    "mobile_phone_23",
    "mobile_phone_23_dnc",
    "mobile_phone_24",
    "mobile_phone_24_dnc",
    "mobile_phone_25",
    "mobile_phone_25_dnc",
    "mobile_phone_26",
    "mobile_phone_26_dnc",
    "mobile_phone_27",
    "mobile_phone_27_dnc",
    "mobile_phone_28",
    "mobile_phone_28_dnc",
    "mobile_phone_29",
    "mobile_phone_29_dnc",
    "mobile_phone_30",
    "mobile_phone_30_dnc",

    # Personal Phones (1-30) + DNC flags
    "personal_phone",
    "personal_phone_dnc",
    "personal_phone_2",
    "personal_phone_2_dnc",
    "personal_phone_3",
    "personal_phone_3_dnc",
    "personal_phone_4",
    "personal_phone_4_dnc",
    "personal_phone_5",
    "personal_phone_5_dnc",
    "personal_phone_6",
    "personal_phone_6_dnc",
    "personal_phone_7",
    "personal_phone_7_dnc",
    "personal_phone_8",
    "personal_phone_8_dnc",
    "personal_phone_9",
    "personal_phone_9_dnc",
    "personal_phone_10",
    "personal_phone_10_dnc",
    "personal_phone_11",
    "personal_phone_11_dnc",
    "personal_phone_12",
    "personal_phone_12_dnc",
    "personal_phone_13",
    "personal_phone_13_dnc",
    "personal_phone_14",
    "personal_phone_14_dnc",
    "personal_phone_15",
    "personal_phone_15_dnc",
    "personal_phone_16",
    "personal_phone_16_dnc",
    "personal_phone_17",
    "personal_phone_17_dnc",
    "personal_phone_18",
    "personal_phone_18_dnc",
    "personal_phone_19",
    "personal_phone_19_dnc",
    "personal_phone_20",
    "personal_phone_20_dnc",
    "personal_phone_21",
    "personal_phone_21_dnc",
    "personal_phone_22",
    "personal_phone_22_dnc",
    "personal_phone_23",
    "personal_phone_23_dnc",
    "personal_phone_24",
    "personal_phone_24_dnc",
    "personal_phone_25",
    "personal_phone_25_dnc",
    "personal_phone_26",
    "personal_phone_26_dnc",
    "personal_phone_27",
    "personal_phone_27_dnc",
    "personal_phone_28",
    "personal_phone_28_dnc",
    "personal_phone_29",
    "personal_phone_29_dnc",
    "personal_phone_30",
    "personal_phone_30_dnc",

    # Company Phones (2-30) + DNC flags
    "company_phone_2",
    "company_phone_2_dnc",
    "company_phone_3",
    "company_phone_3_dnc",
    "company_phone_4",
    "company_phone_4_dnc",
    "company_phone_5",
    "company_phone_5_dnc",
    "company_phone_6",
    "company_phone_6_dnc",
    "company_phone_7",
    "company_phone_7_dnc",
    "company_phone_8",
    "company_phone_8_dnc",
    "company_phone_9",
    "company_phone_9_dnc",
    "company_phone_10",
    "company_phone_10_dnc",
    "company_phone_11",
    "company_phone_11_dnc",
    "company_phone_12",
    "company_phone_12_dnc",
    "company_phone_13",
    "company_phone_13_dnc",
    "company_phone_14",
    "company_phone_14_dnc",
    "company_phone_15",
    "company_phone_15_dnc",
    "company_phone_16",
    "company_phone_16_dnc",
    "company_phone_17",
    "company_phone_17_dnc",
    "company_phone_18",
    "company_phone_18_dnc",
    "company_phone_19",
    "company_phone_19_dnc",
    "company_phone_20",
    "company_phone_20_dnc",
    "company_phone_21",
    "company_phone_21_dnc",
    "company_phone_22",
    "company_phone_22_dnc",
    "company_phone_23",
    "company_phone_23_dnc",
    "company_phone_24",
    "company_phone_24_dnc",
    "company_phone_25",
    "company_phone_25_dnc",
    "company_phone_26",
    "company_phone_26_dnc",
    "company_phone_27",
    "company_phone_27_dnc",
    "company_phone_28",
    "company_phone_28_dnc",
    "company_phone_29",
    "company_phone_29_dnc",
    "company_phone_30",
    "company_phone_30_dnc",

    # Valid phones aggregate
    "valid_phones",

    # Business Email fields
    "business_email",
    "business_email_2",
    "business_email_3",
    "business_email_4",
    "business_email_5",
    "business_email_6",
    "business_email_7",
    "business_email_8",
    "business_email_9",
    "business_email_10",
    "business_email_11",
    "business_email_12",
    "business_email_13",
    "business_email_14",
    "business_email_15",
    "business_email_16",
    "business_email_17",
    "business_email_18",
    "business_email_19",
    "business_email_20",
    "business_email_21",
    "business_email_22",
    "business_email_23",
    "business_email_24",
    "business_email_25",
    "business_email_26",
    "business_email_27",
    "business_email_28",
    "business_email_29",
    "business_email_30",

    # Personal Email fields
    "personal_email",
    "personal_emails",
    "personal_email_1",
    "personal_email_2",
    "personal_email_3",
    "personal_email_4",
    "personal_email_5",
    "personal_email_6",
    "personal_email_7",
    "personal_email_8",
    "personal_email_9",
    "personal_email_10",
    "personal_email_11",
    "personal_email_12",
    "personal_email_13",
    "personal_email_14",
    "personal_email_15",
    "personal_email_16",
    "personal_email_17",
    "personal_email_18",
    "personal_email_19",
    "personal_email_20",
    "personal_email_21",
    "personal_email_22",
    "personal_email_23",
    "personal_email_24",
    "personal_email_25",
    "personal_email_26",
    "personal_email_27",
    "personal_email_28",
    "personal_email_29",
    "personal_email_30",

    # Verified Email fields
    "personal_verified_email",
    "personal_verified_emails",
    "personal_verified_email_2",
    "personal_verified_email_3",
    "personal_verified_email_4",
    "personal_verified_email_5",
    "personal_verified_email_6",
    "personal_verified_email_7",
    "personal_verified_email_8",
    "personal_verified_email_9",
    "personal_verified_email_10",
    "personal_verified_email_11",
    "personal_verified_email_12",
    "personal_verified_email_13",
    "personal_verified_email_14",
    "personal_verified_email_15",
    "personal_verified_email_16",
    "personal_verified_email_17",
    "personal_verified_email_18",
    "personal_verified_email_19",
    "personal_verified_email_20",
    "personal_verified_email_21",
    "personal_verified_email_22",
    "personal_verified_email_23",
    "personal_verified_email_24",
    "personal_verified_email_25",
    "personal_verified_email_26",
    "personal_verified_email_27",
    "personal_verified_email_28",
    "personal_verified_email_29",
    "personal_verified_email_30",
    "business_verified_email",
    "business_verified_emails",
    "business_verified_email_2",
    "business_verified_email_3",
    "business_verified_email_4",
    "business_verified_email_5",
    "business_verified_email_6",
    "business_verified_email_7",
    "business_verified_email_8",
    "business_verified_email_9",
    "business_verified_email_10",
    "business_verified_email_11",
    "business_verified_email_12",
    "business_verified_email_13",
    "business_verified_email_14",
    "business_verified_email_15",
    "business_verified_email_16",
    "business_verified_email_17",
    "business_verified_email_18",
    "business_verified_email_19",
    "business_verified_email_20",
    "business_verified_email_21",
    "business_verified_email_22",
    "business_verified_email_23",
    "business_verified_email_24",
    "business_verified_email_25",
    "business_verified_email_26",
    "business_verified_email_27",
    "business_verified_email_28",
    "business_verified_email_29",
    "business_verified_email_30",

    # Professional Information
    "job_title",
    "headline",
    "department",
    "seniority_level",
    "inferred_years_experience",
    "company_name_history",
    "job_title_history",
    "education_history",
    "skills",

    # Company Information
    "company_address",
    "company_description",
    "company_domain",
    "company_employee_count",
    "company_linkedin_url",
    "company_name",
    "company_phone",
    "company_revenue",
    "company_sic",
    "company_naics",
    "company_city",
    "company_state",
    "company_zip",
    "company_industry",

    # Social Media
    "linkedin_url",
    "facebook_url",
    "twitter_url",

    # Skiptrace Information
    "skiptrace_match_score",
    "skiptrace_name",
    "skiptrace_address",
    "skiptrace_city",
    "skiptrace_state",
    "skiptrace_zip",
    "skiptrace_landline_numbers",
    "skiptrace_wireless_numbers",
    "skiptrace_credit_rating",
    "skiptrace_dnc",
    "skiptrace_exact_age",
    "skiptrace_ethnic_code",
    "skiptrace_language_code",
    "skiptrace_ip",
    "skiptrace_b2b_address",
    "skiptrace_b2b_phone",
    "skiptrace_b2b_source",
    "skiptrace_b2b_website",

    # CRM/Marketing Fields
    "creation_source",
    "initial_notes",
    "interests",
    "lead_score",
    "referral_source",
    "social_connections",
    "source_form_id",
    "source_form_name",
    "utm_source",
    "utm_medium",
    "utm_campaign",
    "utm_term",
    "utm_content",

    # Enhanced Data (JSONB)
    "phones",
    "addresses",
    "websites",
    "overflow_data",

    # Email Marketing
    "unsubscribed",
    "unsubscribed_at",

    # Object Relationships
    "object_ids",
    "primary_object_id",
    "assigned_user_ids",

    # Metadata
    "notes",
    "is_active",
    "created_at",
    "updated_at",
    "is_deleted",
}
```

## BLOCKED Fields (NOT in whitelist)

These fields are intentionally excluded from search:

| Field | Reason |
|-------|--------|
| `id` | Primary key, not useful for filtering |
| `provider_uuid` | Internal provider reference |
| `sha256_personal_email` | Sensitive email hash |
| `sha256_business_email` | Sensitive email hash |
| `sha256_personal_email_1` through `sha256_personal_email_30` | Sensitive email hashes |
| `sha256_business_email_1` through `sha256_business_email_30` | Sensitive email hashes |
| `deleted_at` | Internal audit field |
| `deleted_by` | Internal audit field |
| `created_by_user_id` | Internal audit field |

## Validation Code

Add this validation at the start of `search_contacts` function:

```python
# Validate that all requested fields are in the whitelist
for f in request.filters:
    if f.field not in ALLOWED_SEARCH_FIELDS:
        raise HTTPException(
            status_code=400,
            detail=f"Field '{f.field}' is not allowed for searching"
        )
```

## Security Rationale

1. **SHA256 Hash Fields**: These contain hashed email addresses used for identity matching. Allowing search on these could enable rainbow table attacks or email enumeration.

2. **Provider UUID**: Internal reference to data provider, not useful for users and could leak provider relationships.

3. **Audit Fields**: `deleted_by`, `created_by_user_id`, `deleted_at` are internal audit trails that shouldn't be exposed in search.

4. **Primary Key**: The `id` field is a UUID that shouldn't be used as a search filter (use direct lookup instead).

## Approved By

- Date: 2025-12-07
- CVE Context: Implemented as part of security hardening after CVE-2025-66478 incident
